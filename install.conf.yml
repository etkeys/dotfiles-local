- defaults:
    link:
        create: true
        force: true
        relink: true 
    shell:
        stderr: true
        stdout: true


- create: 
    - ~/bin/i3blocklets
    - ~/repos
    - ~/.themes


- sudo:
    - shell:
        - description: Add Microsoft .NET Core package signing key
          command: >
              cd /tmp && 
              wget -q "https://packages.microsoft.com/config/ubuntu/$(lsb_release --short --release)/packages-microsoft-prod.deb" &&
              dpkg -i packages-microsoft-prod.deb

        
        - description: Add repo for steam
          command: yes | add-apt-repository multiverse


        - description: Add ppa for Regolith Desktop
          command: yes | add-apt-repository ppa:regolith-linux/release

        
        - description: Perform apt cache update
          command: apt-get update


          # install-packages.py should have a link in /root/bin
        - description: Install packages
          command: install-packages.py --tags "any"


        - description: Build and install i3blocks
          command: >
              REPO=$(git config --file=.gitmodules --get submodule.i3blocks.path) &&
              cd "$REPO" &&
              ./autogen.sh &&
              ./configure &&
              make &&
              make install


        - description: Configure qemu-virgil
          command: >
              (command -v snap && snap list qemu-virgil) >/dev/null 2>&1 &&
              (
                  snap connect qemu-virgil:audio-record &&
                  snap connect qemu-virgil:kvm &&
                  snap connect qemu-virgil:raw-usb &&
                  snap connect qemu-virgil:removable-media
              ) ||
              echo "qemu-virgil not installed... skipping."


        - description: Add installing user to kvm group
          command: adduser ${SUDO_USER} kvm


- link:
    ~/:
        path: home/.*
        glob: true
        exclude:
            - home/.gitignore
    ~/.config: ~ 
    ~/toby:
        path: /nfs/home/$USER
        ignore-missing: true
    ~/VirtualBoxVMs:
        path: $VMDIR/$USER/virtualbox
        ignore-missing: true
        if: '[ ! -z $VMDIR ]'


- shell:
    - description: Build i3 config file
      command: config/i3/build-i3-config.sh


    - description: Install i3blocks blocklets
      command: >
          export BLOCKLETS_DEPLOY_DIR=~/bin/i3blocklets &&
          cd sublib/i3blocklets &&
          ./deploy


    # TODO What if there is more than just one theme file?
    # TODO Should these tar files be move to some object storage location and not git?
    - description: Install theme files
      stdout: false
      command: >
          cd ~ &&
          ls .dotfiles.local/themes/*.tar.gz | head -n 1 | xargs tar -vxf


